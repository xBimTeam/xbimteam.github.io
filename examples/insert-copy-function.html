<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="xbim toolkit is an Open Source toolkit for IFC and BIM. You can use it to do anything with IFC. It implements IFC2x3 and IFC4 and allows to develop SW agnostic to IFC version and file format.">
    <meta name="author" content="xbim ltd.">
	<meta name="keywords" content="xbim,BIM,C#,CSharp,NET,OpenBIM,IFC,buildingSMART,standard,documentation,examples">
	<meta name="google-site-verification" content="0uIEEP0H5QWrL3gUPIdxOhMzGT0ZArO6rdpj9TOeeEQ" />

    <link rel="icon" href="../img/favicon.ico">

    <title>Insert Copy Function</title>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Google fonts -->
	<link target="_blank" href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;700&family=Roboto:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet"> 

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom styles for this template -->
    <link href="../css/codestyles.css" rel="stylesheet">
    <link href="../css/site.css" rel="stylesheet">

    <script src="../js/jquery.min.js"></script>

	<!-- Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-51899259-2', 'auto');
		ga('send', 'pageview');
	</script>

	<!-- JSON-LD markup generated by Google Structured Data Markup Helper. -->
	<script type="application/ld+json">
	{
	  "@context" : "http://schema.org",
	  "@type" : "SoftwareApplication",
	  "name" : "xbim toolkit",
	  "image" : "https://docs.xbim.net../img/xBim_toolkit_logo.png",
	  "url" : "https://docs.xbim.net/",
	  "author" : {
	    "@type" : "Person",
	    "name" : "prof. Steve Lockley"
	  },
	  "applicationCategory" : "BIM",
	  "downloadUrl" : "https://www.nuget.org/packages?q=xbim",
	  "softwareVersion" : "4.0"
	}
	</script>
  </head>
<!-- NAVBAR
================================================== -->
  <body>

    <nav class="navbar navbar-inverse">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html"><img alt="logo" src="../img/xBim_toolkit_logo.png"/></a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          		   
	<ul class="nav navbar-nav">
		
        <li>
			<a href="../quick-start.html">Quick Start</a>
		</li>
		
        <li>
			<a href="../docs.html">Docs</a>
		</li>
        <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Examples <span class="caret"></span></a>
			
	<ul class="dropdown-menu">
		
        <li>
			<a href="../examples/examples-list.html">Examples list</a>
		</li>
		<li role="separator" class="group-divider">Basic </li>
		
        <li>
			<a href="../examples/basic-model-operations.html">Basic Model Operations</a>
		</li>
		
        <li>
			<a href="../examples/watch-the-log.html">Watch the log!</a>
		</li>
		
        <li>
			<a href="../examples/proper-wall-in-3d.html">Proper Wall in 3D</a>
		</li>
		
        <li>
			<a href="../examples/step-to-xml-and-back-again.html">STEP to XML and Back Again</a>
		</li>
		
        <li>
			<a href="../examples/creating-wexbim-file.html">Creating wexBIM file</a>
		</li>
		
        <li>
			<a href="../examples/using-linq-for-optimal-performance.html">Using LINQ for Optimal Performance</a>
		</li>
		
        <li>
			<a href="../examples/excel-space-report-from-ifc.html">Excel Space Report from IFC</a>
		</li>
		
        <li>
			<a href="../examples/spatial-hierarchy.html">Spatial hierarchy</a>
		</li>
		<li role="separator" class="group-divider">Advanced </li>
		
        <li>
			<a href="../examples/federating-models.html">Federating Models</a>
		</li>
        <li class="active">
			<a href="../examples/insert-copy-function.html">Insert Copy Function</a>
		</li>
		
        <li>
			<a href="../examples/change-log-creation.html">Change Log Creation</a>
		</li>
		<li role="separator" class="group-divider">Web UI  </li>
		
        <li>
			<a href="../examples/hello-building.html">Hello Building</a>
		</li>
		
        <li>
			<a href="../examples/safe-hello-building.html">Safe Hello Building</a>
		</li>
		
        <li>
			<a href="../examples/eventful-building.html">Eventful Building</a>
		</li>
		
        <li>
			<a href="../examples/building-seen-from-everywhere.html">Building Seen from Everywhere</a>
		</li>
		
        <li>
			<a href="../examples/colourful-building.html">Colourful Building</a>
		</li>
    </ul>

		</li>
        <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Release notes <span class="caret"></span></a>
			
	<ul class="dropdown-menu">
		
        <li>
			<a href="../release-notes/fast-upgrade-track.html">Fast Upgrade Track</a>
		</li>
		
        <li>
			<a href="../release-notes/xbim-4-release-notes.html">xBIM 4 Release Notes</a>
		</li>
    </ul>

		</li>
        <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Research <span class="caret"></span></a>
			
	<ul class="dropdown-menu">
		
        <li>
			<a href="../research/history.html">History</a>
		</li>
		
        <li>
			<a href="../research/how-to-reference.html">How to reference</a>
		</li>
		
        <li>
			<a href="../research/ifc2x3-test-harness.html">Ifc2X3 Test Harness</a>
		</li>
    </ul>

		</li>
        <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Downloads <span class="caret"></span></a>
			
	<ul class="dropdown-menu">
		
        <li>
			<a href="../downloads/xbimxplorer.html">XbimXplorer</a>
		</li>
    </ul>

		</li>
		
        <li>
			<a href="../cloud.html">Cloud</a>
		</li>
        <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">License <span class="caret"></span></a>
			
	<ul class="dropdown-menu">
		
        <li>
			<a href="../license/license.html">License</a>
		</li>
		
        <li>
			<a href="../license/third-party-licenses.html">Third Party Licenses</a>
		</li>
    </ul>

		</li>
    </ul>

        </div><!--/.nav-collapse -->
      </div>
    </nav>

	<div class="container">
	<h1>Insert Copy Function</h1>

<p>Merging and deleting entities in IFC models is a non-trivial task because IFC is not a hierarchical structure. It is a complex structure with 
potential cyclic relations an bi-directional navigation. Where it is not a problem to perform these tasks on a single entity (which you can imagine as a single line in STEP21 file)</p>

<pre><code>#144= IFCBUILDINGSTOREY('026ajlHVj1HBm_osQm7IDT',#47,'Lower Roof - Slab Level',$,$,#143,$,'Lower Roof - Slab Level',.ELEMENT.,3199.99999999704);
</code></pre>

<p>it becomes increasingly difficult once you want to isolate complete data islands defining the entity and you want to either delete it without side effects on other entities outside
the data island or you want to merge it so it blends into existing data without creating duplicities and inconsistencies. For these reasons we prefer the third option which is to 
choose what you want and to copy it over into an empty model. This is obviously potentially complex and complicated task as well but it is easier to keep 
things under your control at least. The core function which is now member of <code>IModel</code> interface is <code>InsertCopy()</code>:</p>

<div class="csharp"><pre><code><span class="type">T</span> <span class="type">InsertCopy</span>&lt;<span class="type">T</span>&gt;(<span class="type">T</span> toCopy, <span class="type">XbimInstanceHandleMap</span> mappings, <span class="type">PropertyTranformDelegate</span> propTransform, <span class="keyword">bool</span> includeInverses, <span class="keyword">bool</span> keepLabels);
</code></pre></div>

<p>Just as a brief description of all arguments are:</p>

<ul>
<li><em>toCopy</em>: Entity to be copied</li>
<li><em>mappings</em>: Mappings of previous inserts. There should always only be <strong>one instance for all insertions between two models</strong>.</li>
<li><em>propTransform</em>: Optional delegate which you can use to filter the content which will get coppied over or transform it before it gets copied. This is very powerful. </li>
<li><em>includeInverses</em>: Option to bring in all inverse entities. This is potentially dangerous as it might easily bring over almost entire model if not further constrained by propTransform delegate.</li>
<li><em>keepLabels</em>: Option to keep entity labels the same. It might be useful to keep labels the same sometimes. <strong>Never</strong> use this option if the target model is not a new model or if you insert objects from multiple models.</li>
</ul>

<p>From all these <code>PropertyTranformDelegate</code> might seem to be little bit cryptic. But it is a fundamental part of the approach described above because it allows to control extent of
the data being copied over. If you allow inverses and don't provide any additional filtering you will most probably end up with the model containing 98% of the original model
even if you just try to copy over a single wall. To use it properly you will need to understand structure of IFC very well. Here is a simple example of a powerful transform which 
will leave out all the geometry and placement and will only allow inverse relations describing type of the product and its properties. Geometry takes typically about 90% of the file
so if you are not interested in graphics or analyses based on geometry you can use this to create very small IFC file containing just descriptive data.</p>

<div class="csharp"><pre><code><span class="type">PropertyTranformDelegate</span> semanticFilter = (property, parentObject) =&gt;
{
    <span class="comment">//leave out geometry and placement</span>
    <span class="keyword">if</span> (parentObject <span class="keyword">is</span> <span class="type">IIfcProduct</span> &amp;&amp;
        (property.PropertyInfo.Name == nameof(<span class="type">IIfcProduct</span>.Representation) ||
        property.PropertyInfo.Name == nameof(<span class="type">IIfcProduct</span>.ObjectPlacement)))
        <span class="keyword">return</span> <span class="keyword">null</span>;

    <span class="comment">//leave out mapped geometry</span>
    <span class="keyword">if</span> (parentObject <span class="keyword">is</span> <span class="type">IIfcTypeProduct</span> &amp;&amp; 
        property.PropertyInfo.Name == nameof(<span class="type">IIfcTypeProduct</span>.RepresentationMaps))
        <span class="keyword">return</span> <span class="keyword">null</span>;

    <span class="comment">//only bring over IsDefinedBy and IsTypedBy inverse relationships which will take over all properties and types</span>
    <span class="keyword">if</span> (property.EntityAttribute.Order &lt; 0 &amp;&amp; !(
        property.PropertyInfo.Name == nameof(<span class="type">IIfcProduct</span>.IsDefinedBy) ||
        property.PropertyInfo.Name == nameof(<span class="type">IIfcProduct</span>.IsTypedBy)
        ))
        <span class="keyword">return</span> <span class="keyword">null</span>;

    <span class="keyword">return</span> property.PropertyInfo.GetValue(parentObject, <span class="keyword">null</span>);
};
</code></pre></div>

<p><code>PropertyTranformDelegate</code> takes two arguments where the first is <code>ExpressMetaProperty</code> and the second is an <code>object</code> which represents <code>IPersistEntity</code>.
<code>ExpressMetaProperty</code> is a cached object which is part of our own reflection meta model which we use for some data operations.
The delegate is used in other code which uses C# reflection to inspect the data and copy values over. If you don't specify a delegate <code>InsertCopy()</code>
will use all properties in the entity and copy them over. </p>

<div class="csharp"><pre><code><span class="keyword">using</span> <span class="type">Xbim</span>.Common;
<span class="keyword">using</span> <span class="type">Xbim</span>.Ifc;
<span class="keyword">using</span> <span class="type">Xbim</span>.Ifc4.Interfaces;

<span class="keyword">namespace</span> <span class="type">BasicExamples</span>
{
    <span class="keyword">class</span> <span class="type">InsertCopy</span>
    {
        <span class="keyword">public</span> <span class="keyword">void</span> CopyWallsOver()
        {
            <span class="keyword">const</span> <span class="keyword">string</span> original = <span class="string">&quot;SampleHouse.ifc&quot;</span>;
            <span class="keyword">const</span> <span class="keyword">string</span> inserted = <span class="string">&quot;SampleHouseWalls.ifc&quot;</span>;

            <span class="type">PropertyTranformDelegate</span> semanticFilter = (property, parentObject) =&gt;
            {
                <span class="comment">//leave out geometry and placement</span>
                <span class="keyword">if</span> (parentObject <span class="keyword">is</span> <span class="type">IIfcProduct</span> &amp;&amp;
                    (property.PropertyInfo.Name == nameof(<span class="type">IIfcProduct</span>.Representation) ||
                    property.PropertyInfo.Name == nameof(<span class="type">IIfcProduct</span>.ObjectPlacement)))
                    <span class="keyword">return</span> <span class="keyword">null</span>;

               <span class="comment">//leave out mapped geometry</span>
               <span class="keyword">if</span> (parentObject <span class="keyword">is</span> <span class="type">IIfcTypeProduct</span> &amp;&amp; 
                    property.PropertyInfo.Name == nameof(<span class="type">IIfcTypeProduct</span>.RepresentationMaps))
                    <span class="keyword">return</span> <span class="keyword">null</span>;



                <span class="comment">//only bring over IsDefinedBy and IsTypedBy inverse relationships which will take over all properties and types</span>
                <span class="keyword">if</span> (property.EntityAttribute.Order &lt; 0 &amp;&amp; !(
                    property.PropertyInfo.Name == nameof(<span class="type">IIfcProduct</span>.IsDefinedBy) ||
                    property.PropertyInfo.Name == nameof(<span class="type">IIfcProduct</span>.IsTypedBy)
                    ))
                    <span class="keyword">return</span> <span class="keyword">null</span>;

                <span class="keyword">return</span> property.PropertyInfo.GetValue(parentObject, <span class="keyword">null</span>);
            };

            <span class="keyword">using</span> (<span class="keyword">var</span> model = <span class="type">IfcStore</span>.Open(original))
            {
                <span class="keyword">var</span> walls = model.Instances.OfType&lt;<span class="type">IIfcWall</span>&gt;();
                <span class="keyword">using</span> (<span class="keyword">var</span> iModel = <span class="type">IfcStore</span>.Create(model.IfcSchemaVersion, <span class="type">XbimStoreType</span>.InMemoryModel))
                {
                    <span class="keyword">using</span> (<span class="keyword">var</span> txn = iModel.BeginTransaction(<span class="string">&quot;Insert copy&quot;</span>))
                    {
                        <span class="comment">//single map should be used for all insertions between two models</span>
                        <span class="keyword">var</span> map = <span class="keyword">new</span> XbimInstanceHandleMap(model, iModel);

                        <span class="keyword">foreach</span> (<span class="keyword">var</span> wall <span class="keyword">in</span> walls)
                        {
                            iModel.InsertCopy(wall, map, semanticFilter, <span class="keyword">true</span>, <span class="keyword">false</span>);
                        }

                        txn.Commit();
                    }

                    iModel.SaveAs(inserted);
                }
            }
        }
    }
}
</code></pre></div>

    </div>
    

	<div class="brands-container">
	<p><small>Some of the companies using xbim toolkit:</small></p>
		<a target="_blank" href="https://www.xbim.net"><img style="height:65px;" src="../img/xBim_parent_logo_white.svg" class="brand" alt="xbim ltd."></a>
		<img src="../img/logos/northumbria_logo_gray.png" class="brand"/>
		<img src="../img/logos/viewpoint_logo_gray.png" class="brand"/>
		<img src="../img/logos/welplan_logo_gray.png" class="brand"/>
		<img src="../img/logos/nbs_logo_gray.png" class="brand"/>
		<img src="../img/logos/bim_academy_logo_gray.png" class="brand"/>
		<img src="../img/logos/di5_logo_gray.png" class="brand"/>
		<img src="../img/logos/SEMA_logo_gray.png" class="brand"/>
	</div>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>
